<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, March 29, 2014, 3:31 PM -->
<!-- MuClient version 4.91 -->

<!-- Plugin "EsteemEssence" generated by Plugin Wizard -->

<muclient>
<plugin
   name="EsteemEssence"
   id="460f851d99f5ae3c8ca87cbf"
   language="Lua"
   purpose="Calculates Essence worth of esteem"
   date_written="2014-03-29 15:30:24"
   requires="4.91"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants 

<include name="constants.lua"/> -->

<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   match="^It is imbued with ((\d+,)*(\d+)) units of esteem.$"
   name="imbuedEsteem"
   regexp="y"
   script="setNumbers"
   sequence="100"
  >
  </trigger>
  
  <trigger
   enabled="y"
   match="^It appears to be of level (\d+).$"
   name="levelLine"
   regexp="y"
   script="setNumbers"
   sequence="100"
  >
  </trigger>
  
  <trigger
   enabled="y"
   match="^It is smaller than most miniatures.$"
   name="miniLine"
   regexp="y"
   script="setNumbers"
   sequence="100"
  >
  </trigger>
  
</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   enabled="y"
   name="esteemBonus"
   match="^sesteem (tattoo|realm|poteen) (.+)$"
   regexp="y"
   script="setNumbers"
   ignore_case="y"
   sequence="100"
  >
  </alias>
</aliases>

<script>
<![CDATA[ 

valueTable = {

	["esteemValue"] = 0,
	["levelValue"] = 0,
	["levelFactor"] = .05,
	["levelBonus"] = 0,
	["miniValue"] = 0,
	["miniFactor"] = .02,
	["miniBonus"] = 0,
	["realmValue"] = 1000,
	["realmFactor"] = .001,
	["realmBonus"] = 0,
	["tattooValue"] = 0,
	["tattooFactor"] = .001,
	["tattooBonus"] = 0,
	["poteenValue"] = 0,
	["poteenFactor"] = 1,
	["poteenBonus"] = 0,
	["essence"] = 0,

}

function setNumbers(name, line, wildcards)
	
	if name == "imbuedEsteem" then
		valueTable.esteemValue = string.gsub(wildcards[1],",","")
		valueTable.esteemValue = tonumber(valueTable.esteemValue)
		calculateEssence()
	elseif name == "esteemBonus" then
	
		valueSet = wildcards[1] .. "Value"
		bonusSet = wildcards[1] .. "Bonus"
		factorSet = wildcards[1] .. "Factor"
		if valueSet == "realmBonus" then
			otherMod = 1
		else
			otherMod = 0 
		end
	
		valueTable[valueSet] = tonumber(wildcards[2])
		valueTable[bonusSet] = valueTable[valueSet] * valueTable[factorSet] - otherMod
		
		ColourNote("green", "", "You have set " .. valueSet .. " to ".. wildcards[2])
		ColourNote("green", "", "This makes " .. bonusSet .. " set to " .. valueTable[bonusSet])
	else
		valueSet = string.match(name, "(%w+)Line") .. "Value"
		bonusSet = string.match(name, "(%w+)Line") .. "Bonus"
		factorSet = string.match(name, "(%w+)Line") .. "Factor"
		
		if valueSet == "levelValue" then
			valueTable[valueSet] = tonumber(wildcards[1])
			if valueTable[valueSet] > 40 then
				valueTable[valueSet] = 40
			end
			valueTable[bonusSet] = valueTable[valueSet] * valueTable[factorSet]
		elseif valueSet == "miniValue" then
			valueTable[bonusSet] = valueTable.levelValue * valueTable[factorSet]
		end
	end

end


function calculateEssence()

	figurineBonuses = (1 + valueTable.levelBonus + valueTable.miniBonus)
	realmTattooBonus = (1 + valueTable.realmBonus + valueTable.tattooBonus)
	OtherBonuses = (1 + valueTable.poteenBonus)
	esteemFullBonus = figurineBonuses * realmTattooBonus * OtherBonuses

	valueTable.essence = valueTable.esteemValue * 100 * esteemFullBonus
	
	valueTable.essence = addCommas(valueTable.essence)
	ColourNote("lightgrey", "black", 
			   "LevelBonus: " .. valueTable.levelBonus .. 
			 ", Minibonus: " .. valueTable.miniBonus .. 
			 ", RealmBonus: " .. valueTable.realmBonus .. 
			 ", TattooBonus: " .. valueTable.tattooBonus..
			 ", PoteenBonus: " .. valueTable.poteenBonus)
			 
	ColourNote("lightgrey", "black", "It is worth " .. valueTable.essence .. " units of essence.")
	
	valueTable.levelBonus = 0
	valueTable.miniBonus = 0
end

function addCommas(number)	
	local i, j, int = tostring(number):find('(%d+)')
	int = int:reverse():gsub("(%d%d%d)", "%1,")
	return int:reverse():gsub("^,", "")
end

]]>
</script>
</muclient>

