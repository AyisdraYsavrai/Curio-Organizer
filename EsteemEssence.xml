<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, March 29, 2014, 3:31 PM -->
<!-- MuClient version 4.91 -->

<!-- Plugin "EsteemEssence" generated by Plugin Wizard -->

<muclient>
<plugin
   name="EsteemEssence"
   id="460f851d99f5ae3c8ca87cbf"
   language="Lua"
   purpose="Calculates Essence worth of esteem"
   date_written="2014-03-29 15:30:24"
   requires="4.91"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants 

<include name="constants.lua"/> -->

<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   match="^It is imbued with ((\d+,)*(\d+)) units of esteem.$"
   name="imbuedEsteem"
   regexp="y"
   script="DisplayEsteemWorth"
   sequence="100"
  >
  </trigger>
  
  <trigger
   enabled="y"
   match="^It appears to be of level (\d+).$"
   name="levelLine"
   regexp="y"
   script="SetFigurineLevel"
   sequence="100"
  >
  </trigger>
  
  <trigger
   enabled="y"
   match="^It is smaller than most miniatures.$"
   name="miniLine"
   regexp="y"
   script="SetFigurineLevel"
   sequence="100"
  >
  </trigger>
  
</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   enabled="y"
   name="esteemBonus"
   match="^sesteem (level|tattoo|realm|poteen) (.+)$"
   regexp="y"
   script="SetBonusValue"
   ignore_case="y"
   sequence="100"
  >
  </alias>
  <alias
   enabled="y"
   name="esteemTell"
   match="^howmuchessenceis (\d+) (with (\d+) (\d+))?$"
   regexp="y"
   script="howMuch"
   ignore_case="y"
   sequence="100"
  >
  </alias>
</aliases>

<script>
<![CDATA[ 

valueTable = {

	esteemValue = 0,	
	essence = 0,
	
	levelValue = 40,
	levelFactor = .05,
	levelBonus = 0,
	
	-- miniValue = 0,
	miniFactor = .02,
	miniBonus = 0,
	
	realmValue = 1000,
	realmFactor = 1000,
	realmBonus = 0,
	
	tattooValue = 0,
	tattooFactor = .001,
	tattooBonus = 0,
	
	poteenValue = 1,
	poteenFactor = .5,
	poteenBonus = 0,

}

function SetFigurineLevel(name, line, wildcards)
	if name == "levelLine" then
		valueTable.levelValue = tonumber(wildcards[1])
		if valueTable.levelValue > 40 then
			valueTable.levelValue = 40
		end
	elseif name == "miniLine" then
		valueTable.miniValue = valueTable.levelValue
	end
	
	SetBonusNumbers()
end

function SetBonusValue(name, line, wildcards)
	-- SESTEEM <LEVEL|TATTOO|REALM|POTEEN> <level|weight|essence|1>
	valueSet = string.lower(wildcards[1]) .."Value"		
	valueTable[valueSet] = tonumber(wildcards[2])				
	ColourNote("green", "", "You have set " .. valueSet .. " to ".. wildcards[2])
	
	--SetBonusNumbers()
end
	
function DisplayEsteemWorth(name, line, wildcards)
	valueTable.esteemValue = string.gsub(wildcards[1],",","")
	valueTable.esteemValue = tonumber(valueTable.esteemValue)
	CalculateEssence()
end
	
	
function SetBonusNumbers()	
	
	valueTable.levelBonus = valueTable.levelFactor * valueTable.levelValue
	valueTable.miniBonus = valueTable.miniFactor * valueTable.levelValue
	valueTable.realmBonus = (valueTable.realmValue / valueTable.realmFactor) - 1
	valueTable.tattooBonus = valueTable.tattooFactor * valueTable.tattooValue
	valueTable.poteenBonus =  valueTable.poteenFactor * valueTable.poteenValue

end


function CalculateEssence()

	SetBonusNumbers()
	figurineBonuses = (1 + valueTable.levelBonus + valueTable.miniBonus)
	realmTattooBonus = (1 + valueTable.realmBonus + valueTable.tattooBonus)
	otherBonuses = (1 + valueTable.poteenBonus)
	esteemFullBonus = figurineBonuses * realmTattooBonus * otherBonuses

	valueTable.essence = valueTable.esteemValue * 100 * esteemFullBonus
	
	valueTable.essence = addCommas(valueTable.essence)
	ColourNote("lightgrey", "black", 
			   "LevelBonus: " .. valueTable.levelBonus .. 
			 ", Minibonus: " .. valueTable.miniBonus .. 
			 ", RealmBonus: " .. valueTable.realmBonus .. 
			 ", TattooBonus: " .. valueTable.tattooBonus..
			 ", PoteenBonus: " .. valueTable.poteenBonus)
			 
	ColourNote("lightgrey", "black", "It is worth " .. valueTable.essence .. " units of essence.")
end

function howMuch(name, line, wildcards)
	levelbonus = wildcards[3]
	miniBonus = wildcards[4]
	essence = wildcards[1] * 100 * (1 + levelBonus + miniBonus) * (1 + realmBonus + tattooBonus)
	ColourNote("yellow", "black", "With " .. wildcards[1] .. " esteem and bonuses of level, mini, realm, and tattoo being at " .. levelBonus .. ", ".. miniBonus .. ", ".. realmBonus .. ", ".. tattooBonus .. ", this should be a total essence value of " .. essence)
end

function addCommas(number)	
	local i, j, int = tostring(number):find('(%d+)')
	int = int:reverse():gsub("(%d%d%d)", "%1,")
	return int:reverse():gsub("^,", "")
end

]]>
</script>
</muclient>

