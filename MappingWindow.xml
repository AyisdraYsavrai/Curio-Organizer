<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Friday, October 09, 2015, 10:09 PM -->
<!-- MuClient version 4.94 -->

<!-- Plugin "Maps" generated by Plugin Wizard -->

<muclient>
<plugin
   name="MapMiniwindow"
   purpose="Moveable miniwindow for IG map"
   id="f6e4fe20bf031e9f9e3e2a88"
   language="Lua"
   save_state="y"
   date_written="2015-10-09 22:08:41"
   requires="4.94"
   version="1.0"
   >

</plugin>

<triggers>
  <trigger
   enabled="y"
   group="Mapping"
   match="^\-\-\-.+? v\d+ \-\-\-+$"
   name="mapTop"
   omit_from_output="y"
   regexp="y"
   script="mapRedirect"
   send_to="14"
   sequence="1000"
  >
  </trigger>
  
  <trigger
   enabled="y"
   group="Mapping"
   match="^\-\-\-.+? [\-\d]+\:[\-\d]+\:[\-\d]+ \-\-\-+$"
   name="mapBottom"
   omit_from_output="y"
   regexp="y"
   script="mapRedirect"
   send_to="14"
   sequence="1000"
  >
  </trigger>
  
  <trigger
   enabled="n"
   group="Mapping"
   match=".+"
   name="mapContents"
   omit_from_output="y"
   regexp="y"
   script="mapRedirect"
   send_to="14"
   sequence="2000"
  >
  </trigger>
  
  <trigger
   enabled="y"
   group="Mapping"
   match="^Password correct\. Welcome to Lusternia\.$"
   name="mapInit"
   regexp="y"
   send_to="12"
   sequence="1000"
  >
  <send>Send("map")</send>
  </trigger>
  
</triggers>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Script  -->


<script>
<![CDATA[

require "movewindow"

windowName = "mapWindow"
firstTime = false


function mapStart(line, styles)
	EnableTrigger("mapContents", true)
	
	-- If we haven't already created the map window, do so now
	-- Create (required for font loading), load fonts, get w,h, remake window
	if not firstTime then
		movewindow.install (windowName, miniwin.pos_top_right, miniwin.create_absolute_location, true)
		WindowCreate(windowName, 0, 0, 300, 300, 8, 0, ColourNameToRGB("black"))
    
		WindowFont(windowName, "mapFont", "Lucida Console", 8, false, false, false, false)	
	
		windowWidth = WindowFontInfo(windowName, "mapFont", 7) * 45 --329  7*
		windowHeight = WindowFontInfo(windowName, "mapFont", 1) --275 11*25
		
		
		WindowCreate(windowName, 0, 0, windowWidth, windowWidth, 8, 0, ColourNameToRGB("black"))
		WindowRectOp (windowName, miniwin.rect_frame, 0, 0, 0, 0, ColourNameToRGB("lime"))
		WindowRectOp (windowName, miniwin.rect_frame, 1, 1, 0, 0, ColourNameToRGB("lime"))
		
		WindowRectOp (windowName, 2, 0, 0, windowWidth, 17, ColourNameToRGB("green"))
		WindowText(windowName, "mapFont", "MAP WINDOW", windowWidth/2.5, 5, 575, 17, ColourNameToRGB("black"), false)
		
		movewindow.add_drag_handler (windowName, 0, 0, 0, 17)
		WindowShow(windowName, true)
		
		firstTime = true
	end
  
	WindowRectOp("mapWindow", 2, 0, windowHeight+6, windowWidth, windowHeight * 27, ColourNameToRGB("black"))
  
	local left = 0
	for _,s in ipairs(styles) do
		left = left + WindowText("mapWindow", "mapFont", s.text, left, 18, windowWidth - 3, windowHeight * 27, s.textcolour)
	end

  windowLines = 1
end

function mapContents(line, styles)
	local left = 0
    for _,s in ipairs(styles) do
		left = left + WindowText("mapWindow", "mapFont", s.text, left, windowLines * windowHeight+20, windowWidth, windowHeight * 27, s.textcolour)
	end
	windowLines = windowLines + 1
end

function mapEnd(line, styles)
	local left = 0
	for _,s in ipairs(styles) do
		left = left + WindowText("mapWindow", "mapFont", s.text, left, windowLines * windowHeight+20, windowWidth, windowHeight * 27, s.textcolour)
	end

	EnableTrigger("mapContents", false)
end

function mapRedirect(name, line, wildcards, styles)
  if name == "mapTop" then
    mapStart(line, styles)
  elseif name == "mapBottom" then
    mapEnd(line, styles)
  else
    mapContents(line, styles)
  end
end

]]>
</script>
</muclient>
